---
import BaseLayout from "../layouts/BaseLayout.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
---

<BaseLayout title="Generador QR Pro | Jhon Chiguay">
  <Navbar />
  
  <!-- QR Generator Container -->
  <div class="qr-generator-wrapper">
    <div class="container">
      <!-- Header -->
      <header class="header">
        <div class="logo">
          <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="40" height="40" rx="8" fill="url(#gradient)"/>
            <rect x="8" y="8" width="6" height="6" fill="white"/>
            <rect x="8" y="26" width="6" height="6" fill="white"/>
            <rect x="26" y="8" width="6" height="6" fill="white"/>
            <rect x="18" y="18" width="4" height="4" fill="white"/>
            <defs>
              <linearGradient id="gradient" x1="0" y1="0" x2="40" y2="40">
                <stop offset="0%" stop-color="#667eea"/>
                <stop offset="100%" stop-color="#764ba2"/>
              </linearGradient>
            </defs>
          </svg>
          <h1>QR Pro Generator</h1>
        </div>
        <div class="stats">
          <div class="stat-item">
            <span class="stat-number" id="totalQRs">0</span>
            <span class="stat-label">Códigos Generados</span>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Generator Section -->
        <section class="generator-section">
          <div class="card generator-card">
            <h2>Generar Código QR</h2>
            <p class="subtitle">Crea códigos QR permanentes que nunca vencen</p>
            
            <div class="form-group">
              <label for="qrType">Tipo de contenido</label>
              <select id="qrType" class="input-field">
                <option value="url">URL / Sitio Web</option>
                <option value="text">Texto</option>
                <option value="email">Email</option>
                <option value="phone">Teléfono</option>
                <option value="sms">SMS</option>
                <option value="wifi">WiFi</option>
              </select>
            </div>

            <div id="urlFields" class="dynamic-fields">
              <div class="form-group">
                <label for="qrContent">URL del sitio web</label>
                <input type="text" id="qrContent" class="input-field" placeholder="https://ejemplo.com">
              </div>
            </div>

            <div id="textFields" class="dynamic-fields" style="display:none;">
              <div class="form-group">
                <label for="textContent">Texto</label>
                <textarea id="textContent" class="input-field" rows="4" placeholder="Escribe tu texto aquí..."></textarea>
              </div>
            </div>

            <div id="emailFields" class="dynamic-fields" style="display:none;">
              <div class="form-group">
                <label for="emailAddress">Dirección de email</label>
                <input type="email" id="emailAddress" class="input-field" placeholder="correo@ejemplo.com">
              </div>
              <div class="form-group">
                <label for="emailSubject">Asunto (opcional)</label>
                <input type="text" id="emailSubject" class="input-field" placeholder="Asunto del correo">
              </div>
            </div>

            <div id="phoneFields" class="dynamic-fields" style="display:none;">
              <div class="form-group">
                <label for="phoneNumber">Número de teléfono</label>
                <input type="tel" id="phoneNumber" class="input-field" placeholder="+569 1234 5678">
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="useWhatsApp" class="checkbox-field">
                  <span>Abrir en WhatsApp</span>
                </label>
              </div>
              <div id="whatsappMessageField" class="form-group" style="display:none;">
                <label for="whatsappMessage">Mensaje predeterminado (opcional)</label>
                <textarea id="whatsappMessage" class="input-field" rows="3" placeholder="Hola! Me gustaría..."></textarea>
              </div>
            </div>

            <div id="smsFields" class="dynamic-fields" style="display:none;">
              <div class="form-group">
                <label for="smsNumber">Número de teléfono</label>
                <input type="tel" id="smsNumber" class="input-field" placeholder="+34 123 456 789">
              </div>
              <div class="form-group">
                <label for="smsMessage">Mensaje</label>
                <textarea id="smsMessage" class="input-field" rows="3" placeholder="Mensaje del SMS"></textarea>
              </div>
            </div>

            <div id="wifiFields" class="dynamic-fields" style="display:none;">
              <div class="form-group">
                <label for="wifiSSID">Nombre de la red (SSID)</label>
                <input type="text" id="wifiSSID" class="input-field" placeholder="Mi WiFi">
              </div>
              <div class="form-group">
                <label for="wifiPassword">Contraseña</label>
                <input type="text" id="wifiPassword" class="input-field" placeholder="Contraseña">
              </div>
              <div class="form-group">
                <label for="wifiEncryption">Tipo de seguridad</label>
                <select id="wifiEncryption" class="input-field">
                  <option value="WPA">WPA/WPA2</option>
                  <option value="WEP">WEP</option>
                  <option value="nopass">Sin contraseña</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="qrName">Nombre del QR (opcional)</label>
              <input type="text" id="qrName" class="input-field" placeholder="Ej: Mi sitio web personal">
            </div>

            <!-- Personalización de Estilo -->
            <div class="style-section">
              <h3 class="section-title">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 6C4 5.46957 4.21071 4.96086 4.58579 4.58579C4.96086 4.21071 5.46957 4 6 4H14C14.5304 4 15.0391 4.21071 15.4142 4.58579C15.7893 4.96086 16 5.46957 16 6V14C16 14.5304 15.7893 15.0391 15.4142 15.4142C15.0391 15.7893 14.5304 16 14 16H6C5.46957 16 4.96086 15.7893 4.58579 15.4142C4.21071 15.0391 4 14.5304 4 14V6Z M8 8H12M8 12H10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Personalización
              </h3>

              <div class="form-group">
                <label for="qrColor">Color del QR</label>
                <div class="color-picker-group">
                  <input type="color" id="qrColor" value="#000000">
                  <span class="color-value">#000000</span>
                </div>
              </div>

              <div class="form-group">
                <label for="qrStyle">Estilo del patrón</label>
                <select id="qrStyle" class="input-field">
                  <option value="squares">Cuadrados (Clásico)</option>
                  <option value="dots">Puntos redondos</option>
                  <option value="rounded">Esquinas redondeadas</option>
                </select>
              </div>

              <div class="form-group">
                <label for="cornerStyle">Estilo de esquinas</label>
                <select id="cornerStyle" class="input-field">
                  <option value="square">Cuadrado</option>
                  <option value="dot">Punto</option>
                  <option value="rounded">Redondeado</option>
                </select>
              </div>

              <div class="form-group">
                <label for="qrLogo">Logo central (opcional)</label>
                <input type="file" id="qrLogo" class="input-field file-input" accept="image/*">
                <small class="input-hint">Sube una imagen PNG, JPG o SVG</small>
              </div>

              <div class="form-group" id="logoSizeGroup" style="display:none;">
                <label for="logoSize">Tamaño del logo (%)</label>
                <div class="slider-group">
                  <input type="range" id="logoSize" class="slider" min="15" max="35" value="20">
                  <span class="slider-value" id="logoSizeValue">20%</span>
                </div>
              </div>
            </div>

            <button class="btn btn-primary" id="generateBtn">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 5V15M5 10H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Generar Código QR
            </button>
          </div>

          <!-- QR Preview -->
          <div class="card preview-card" id="previewCard" style="display:none;">
            <h3>Vista Previa</h3>
            <div class="qr-preview" id="qrPreview"></div>
            <div class="preview-info" id="previewInfo"></div>
            
            <!-- Unique Code Display -->
            <div class="unique-code-box" id="uniqueCodeBox" style="display:none;">
              <div class="unique-code-content">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 12V10M10 8H10.01M19 10C19 14.9706 14.9706 19 10 19C5.02944 19 1 14.9706 1 10C1 5.02944 5.02944 1 10 1C14.9706 1 19 5.02944 19 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div>
                  <p class="unique-code-label">Código único para recuperar tu QR:</p>
                  <div class="unique-code-value-box">
                    <span class="unique-code-value" id="uniqueCodeValue"></span>
                    <button class="btn-copy-code" id="copyCodeBtn" title="Copiar código">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 4V2C4 1.46957 4.21071 0.960859 4.58579 0.585786C4.96086 0.210714 5.46957 0 6 0H14C14.5304 0 15.0391 0.210714 15.4142 0.585786C15.7893 0.960859 16 1.46957 16 2V10C16 10.5304 15.7893 11.0391 15.4142 11.4142C15.0391 11.7893 14.5304 12 14 12H12M2 4H10C11.1046 4 12 4.89543 12 6V14C12 15.1046 11.1046 16 10 16H2C0.89543 16 0 15.1046 0 14V6C0 4.89543 0.89543 4 2 4Z" fill="currentColor"/>
                      </svg>
                    </button>
                  </div>
                  <small class="unique-code-hint">Guarda este código para recuperar tu QR más tarde</small>
                </div>
              </div>
            </div>

            <div class="button-group">
              <button class="btn btn-secondary" id="downloadBtn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 3V13M10 13L6 9M10 13L14 9M3 17H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Descargar PNG
              </button>
              <button class="btn btn-outline" id="downloadSvgBtn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 3V13M10 13L6 9M10 13L14 9M3 17H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Descargar SVG
              </button>
            </div>
          </div>
        </section>

        <!-- Search QR Section -->
        <section class="history-section">
          <div class="card history-card">
            <div class="history-header">
              <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:inline-block; vertical-align:middle; margin-right:0.5rem;">
                  <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Buscar mi Código QR
              </h2>
            </div>
            <div class="search-qr-section">
              <p class="search-description">Ingresa tu código único de 6 caracteres para recuperar tu código QR</p>
              <div class="search-qr-input-group">
                <input 
                  type="text" 
                  id="codeSearchInput" 
                  class="code-search-input" 
                  placeholder="Ej: ABC123"
                  maxlength="6"
                  autocomplete="off"
                >
                <button class="btn btn-primary" id="searchCodeBtn" style="width:auto;">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 19L13 13M15 8C15 11.866 11.866 15 8 15C4.13401 15 1 11.866 1 8C1 4.13401 4.13401 1 8 1C11.866 1 15 4.13401 15 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Buscar
                </button>
              </div>
              <div id="searchResultBox" class="search-result-box" style="display:none;"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- Footer Info -->
      <div class="qr-footer">
        <p>© 2025 QR Pro Generator - Códigos QR permanentes y sin vencimiento</p>
      </div>
    </div>
  </div>

  <Footer />
</BaseLayout>

<style>
  .qr-generator-wrapper {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding-top: 80px;
  }

  * {
    box-sizing: border-box;
  }

  :root {
    --primary-color: #667eea;
    --primary-dark: #5568d3;
    --secondary-color: #764ba2;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --bg-color: #f8fafc;
    --card-bg: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --border-color: #e2e8f0;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* Header */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
    animation: fadeInDown 0.6s ease-out;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .logo h1 {
    color: white;
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -0.02em;
  }

  .stats {
    display: flex;
    gap: 2rem;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 1rem 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: white;
  }

  .stat-label {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
  }

  /* Main Content */
  .main-content {
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 2rem;
    margin-bottom: 3rem;
  }

  /* Card */
  .card {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: var(--shadow-xl);
    animation: fadeInUp 0.6s ease-out;
  }

  .card h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
  }

  .card h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
  }

  .subtitle {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-bottom: 2rem;
  }

  /* Form */
  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .input-field {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 0.95rem;
    font-family: inherit;
    transition: all 0.2s ease;
    background: var(--card-bg);
  }

  .input-field:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .input-field::placeholder {
    color: var(--text-secondary);
  }

  textarea.input-field {
    resize: vertical;
    min-height: 100px;
  }

  select.input-field {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 3rem;
  }

  .color-picker-group {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .color-picker-group input[type="color"] {
    width: 60px;
    height: 45px;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    padding: 4px;
  }

  .color-value {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .dynamic-fields {
    transition: opacity 0.3s ease;
  }

  /* Checkbox */
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    font-size: 0.95rem;
    color: var(--text-primary);
  }

  .checkbox-field {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--primary-color);
  }

  .checkbox-label span {
    user-select: none;
  }

  /* Style Section */
  .style-section {
    background: var(--bg-color);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border: 2px dashed var(--border-color);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 1rem;
  }

  .section-title svg {
    color: var(--primary-color);
  }

  /* File Input */
  .file-input {
    cursor: pointer;
    padding: 0.6rem 1rem;
  }

  .file-input::-webkit-file-upload-button {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-right: 1rem;
    transition: background 0.2s ease;
  }

  .file-input::-webkit-file-upload-button:hover {
    background: var(--primary-dark);
  }

  .input-hint {
    display: block;
    color: var(--text-secondary);
    font-size: 0.8rem;
    margin-top: 0.4rem;
  }

  /* Slider */
  .slider-group {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .slider {
    flex: 1;
    height: 6px;
    border-radius: 5px;
    background: var(--border-color);
    outline: none;
    -webkit-appearance: none;
  }

  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary-color);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary-color);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .slider-value {
    font-weight: 600;
    color: var(--primary-color);
    min-width: 50px;
    text-align: right;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.875rem 1.75rem;
    font-size: 0.95rem;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
    text-decoration: none;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    width: 100%;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
  }

  .btn-primary:active {
    transform: translateY(0);
  }

  .btn-secondary {
    background: var(--primary-color);
    color: white;
  }

  .btn-secondary:hover {
    background: var(--primary-dark);
  }

  .btn-outline {
    background: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
  }

  .btn-outline:hover {
    background: var(--primary-color);
    color: white;
  }

  .btn-danger-outline {
    background: transparent;
    border: 2px solid var(--danger-color);
    color: var(--danger-color);
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }

  .btn-danger-outline:hover {
    background: var(--danger-color);
    color: white;
  }

  .button-group {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .button-group .btn {
    flex: 1;
  }

  /* Preview Card */
  .preview-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
  }

  .qr-preview {
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    margin-bottom: 1.5rem;
  }

  .qr-preview canvas {
    display: block;
    border-radius: 8px;
  }

  .preview-info {
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  /* Unique Code Box */
  .unique-code-box {
    display: none;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border: 2px dashed var(--primary-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .unique-code-content {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
  }

  .unique-code-content svg {
    color: var(--primary-color);
    flex-shrink: 0;
    margin-top: 0.2rem;
  }

  .unique-code-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .unique-code-value-box {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: white;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 2px solid var(--border-color);
    margin-bottom: 0.5rem;
  }

  .unique-code-value {
    font-family: 'Courier New', monospace;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    letter-spacing: 0.2em;
    flex: 1;
  }

  .btn-copy-code {
    background: var(--primary-color);
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-copy-code:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
  }

  .btn-copy-code:active {
    transform: scale(0.95);
  }

  .unique-code-hint {
    color: var(--text-secondary);
    font-size: 0.75rem;
  }

  /* Search QR Section */
  .search-qr-section {
    padding: 1rem 0;
  }

  .search-description {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .search-qr-input-group {
    display: flex;
    gap: 1rem;
    max-width: 500px;
    margin: 0 auto 1.5rem;
  }

  .code-search-input {
    flex: 1;
    padding: 0.875rem 1.25rem;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    text-align: center;
    transition: all 0.2s ease;
  }

  .code-search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .search-result-box {
    background: var(--bg-color);
    border-radius: 12px;
    padding: 1.5rem;
    animation: fadeInUp 0.3s ease;
  }

  .search-result-qr {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .search-result-info {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .search-result-info p {
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
  }

  .search-result-info strong {
    color: var(--text-primary);
  }

  .search-error {
    text-align: center;
    padding: 2rem;
    color: var(--danger-color);
  }

  .search-error svg {
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .search-success {
    display: flex;
    gap: 2rem;
    align-items: flex-start;
  }

  .search-qr-preview {
    flex-shrink: 0;
    background: white;
    padding: 1rem;
    border-radius: 8px;
  }

  .search-qr-info {
    flex: 1;
  }

  .search-qr-info h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
  }

  .search-qr-info p {
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
    word-break: break-word;
  }

  .search-qr-info code {
    background: rgba(168, 85, 247, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: var(--primary-color);
    font-weight: bold;
  }

  .search-actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .search-actions .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  @media (max-width: 768px) {
    .search-success {
      flex-direction: column;
      align-items: center;
    }
    
    .search-actions {
      width: 100%;
    }
    
    .search-actions .btn {
      flex: 1;
    }
  }

  /* History Section */
  .history-card {
    grid-column: 1 / -1;
  }

  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .history-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .search-input {
    padding: 0.5rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.9rem;
    min-width: 250px;
    transition: all 0.2s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .history-item {
    background: var(--bg-color);
    border-radius: 16px;
    padding: 1.5rem;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
    cursor: pointer;
    animation: fadeIn 0.3s ease;
  }

  .history-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-color);
  }

  .history-item-qr {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    display: flex;
    justify-content: center;
  }

  .history-item-qr canvas {
    border-radius: 8px;
  }

  .history-item-info {
    margin-bottom: 1rem;
  }

  .history-item-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    font-size: 1rem;
  }

  .history-item-content {
    color: var(--text-secondary);
    font-size: 0.85rem;
    word-break: break-all;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .history-item-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }

  .history-item-type {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.7rem;
  }

  .history-item-actions {
    display: flex;
    gap: 0.5rem;
  }

  .icon-btn {
    background: white;
    border: 2px solid var(--border-color);
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .icon-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: scale(1.1);
  }

  .icon-btn.delete:hover {
    border-color: var(--danger-color);
    color: var(--danger-color);
  }

  /* Empty State */
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
  }

  .empty-state svg {
    margin-bottom: 1.5rem;
    opacity: 0.5;
  }

  .empty-state p {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
  }

  .empty-subtitle {
    font-size: 0.9rem !important;
    opacity: 0.7;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideUp 0.3s ease;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: var(--bg-color);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: var(--border-color);
    transform: rotate(90deg);
  }

  .modal-body {
    margin: 2rem 0;
  }

  .modal-qr {
    background: var(--bg-color);
    padding: 2rem;
    border-radius: 12px;
    display: flex;
    justify-content: center;
    margin-bottom: 1.5rem;
  }

  .modal-info {
    background: var(--bg-color);
    padding: 1.5rem;
    border-radius: 12px;
  }

  .modal-info p {
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
    word-break: break-all;
  }

  .modal-info strong {
    color: var(--text-primary);
  }

  .modal-footer {
    display: flex;
    gap: 1rem;
  }

  .modal-footer .btn {
    flex: 1;
  }

  /* Footer */
  .qr-footer {
    text-align: center;
    padding: 2rem;
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
  }

  /* Animations */
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideUp {
    from {
      transform: translateY(50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .main-content {
      grid-template-columns: 1fr;
    }
    
    .history-grid {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
  }

  @media (max-width: 768px) {
    .container {
      padding: 1rem;
    }
    
    .header {
      flex-direction: column;
      gap: 1.5rem;
      text-align: center;
    }
    
    .logo h1 {
      font-size: 1.5rem;
    }
    
    .stats {
      width: 100%;
      justify-content: center;
    }
    
    .history-header {
      flex-direction: column;
      align-items: stretch;
    }
    
    .history-actions {
      flex-direction: column;
    }
    
    .search-input {
      width: 100%;
    }
    
    .history-grid {
      grid-template-columns: 1fr;
    }
    
    .modal-content {
      width: 95%;
      padding: 1.5rem;
    }
  }

  @media (max-width: 480px) {
    .card {
      padding: 1.5rem;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .stat-item {
      padding: 0.75rem 1rem;
    }
    
    .stat-number {
      font-size: 1.5rem;
    }
  }
</style>

<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script is:inline>
  // Wait for QRious to load
  window.addEventListener('load', function() {
    if (typeof QRious === 'undefined') {
      console.error('QRious no se cargó correctamente');
      return;
    }
    
    console.log('QRious cargado correctamente');
    
  // Storage Manager
  class QRStorage {
    constructor() {
      this.storageKey = 'qr_pro_codes';
    }

    // Generate unique 6-character code
    generateUniqueCode() {
      const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Excluding similar looking chars
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      // Check if code already exists
      const codes = this.getAll();
      if (codes.some(c => c.uniqueCode === code)) {
        return this.generateUniqueCode(); // Recursive if collision
      }
      return code;
    }

    getAll() {
      try {
        const data = localStorage.getItem(this.storageKey);
        return data ? JSON.parse(data) : [];
      } catch (error) {
        console.error('Error loading QR codes:', error);
        return [];
      }
    }

    save(qrData) {
      try {
        const codes = this.getAll();
        // Add unique code if not present
        if (!qrData.uniqueCode) {
          qrData.uniqueCode = this.generateUniqueCode();
        }
        codes.unshift(qrData);
        localStorage.setItem(this.storageKey, JSON.stringify(codes));
        return qrData.uniqueCode;
      } catch (error) {
        console.error('Error saving QR code:', error);
        return null;
      }
    }

    findByCode(code) {
      const codes = this.getAll();
      return codes.find(c => c.uniqueCode === code.toUpperCase());
    }

    delete(id) {
      try {
        const codes = this.getAll();
        const filtered = codes.filter(code => code.id !== id);
        localStorage.setItem(this.storageKey, JSON.stringify(filtered));
        return true;
      } catch (error) {
        console.error('Error deleting QR code:', error);
        return false;
      }
    }

    clear() {
      try {
        localStorage.removeItem(this.storageKey);
        return true;
      } catch (error) {
        console.error('Error clearing QR codes:', error);
        return false;
      }
    }
  }

  // QR Generator Manager
  class QRGenerator {
    constructor() {
      console.log('Inicializando QR Generator...');
      this.storage = new QRStorage();
      this.currentQR = null;
      this.initElements();
      this.initEventListeners();
      console.log('QR Generator inicializado correctamente');
    }

    initElements() {
      // Form elements
      this.qrType = document.getElementById('qrType');
      this.qrContent = document.getElementById('qrContent');
      this.qrName = document.getElementById('qrName');
      this.qrColor = document.getElementById('qrColor');
      this.generateBtn = document.getElementById('generateBtn');
      
      // Style elements
      this.qrStyle = document.getElementById('qrStyle');
      this.cornerStyle = document.getElementById('cornerStyle');
      this.qrLogo = document.getElementById('qrLogo');
      this.logoSize = document.getElementById('logoSize');
      this.logoSizeValue = document.getElementById('logoSizeValue');
      this.logoSizeGroup = document.getElementById('logoSizeGroup');
      
      // Logo data
      this.logoImage = null;
      
      // Dynamic fields
      this.urlFields = document.getElementById('urlFields');
      this.textFields = document.getElementById('textFields');
      this.emailFields = document.getElementById('emailFields');
      this.phoneFields = document.getElementById('phoneFields');
      this.smsFields = document.getElementById('smsFields');
      this.wifiFields = document.getElementById('wifiFields');
      
      // WhatsApp elements
      this.useWhatsApp = document.getElementById('useWhatsApp');
      this.whatsappMessageField = document.getElementById('whatsappMessageField');
      
      // Preview elements
      this.previewCard = document.getElementById('previewCard');
      this.qrPreview = document.getElementById('qrPreview');
      this.previewInfo = document.getElementById('previewInfo');
      this.downloadBtn = document.getElementById('downloadBtn');
      this.downloadSvgBtn = document.getElementById('downloadSvgBtn');
      
      // Unique code elements
      this.uniqueCodeBox = document.getElementById('uniqueCodeBox');
      this.uniqueCodeValue = document.getElementById('uniqueCodeValue');
      this.copyCodeBtn = document.getElementById('copyCodeBtn');
      
      // Search elements
      this.codeSearchInput = document.getElementById('codeSearchInput');
      this.searchCodeBtn = document.getElementById('searchCodeBtn');
      this.searchResultBox = document.getElementById('searchResultBox');
    }

    initEventListeners() {
      // Type selector
      this.qrType.addEventListener('change', () => this.handleTypeChange());
      
      // Color picker
      this.qrColor.addEventListener('input', (e) => {
        document.querySelector('.color-value').textContent = e.target.value;
      });
      
      // Logo upload
      this.qrLogo.addEventListener('change', (e) => this.handleLogoUpload(e));
      
      // Logo size slider
      this.logoSize.addEventListener('input', (e) => {
        this.logoSizeValue.textContent = e.target.value + '%';
      });
      
      // WhatsApp checkbox
      this.useWhatsApp.addEventListener('change', (e) => {
        this.whatsappMessageField.style.display = e.target.checked ? 'block' : 'none';
      });
      
      // Generate button
      this.generateBtn.addEventListener('click', () => {
        console.log('Botón generar clickeado');
        this.generateQR();
      });
      
      // Download buttons
      this.downloadBtn.addEventListener('click', () => this.downloadQR('png'));
      this.downloadSvgBtn.addEventListener('click', () => this.downloadQR('svg'));
      
      // Copy unique code button
      this.copyCodeBtn.addEventListener('click', () => this.copyUniqueCode());
      
      // Search by code
      this.codeSearchInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
      });
      this.codeSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') this.searchByCode();
      });
      this.searchCodeBtn.addEventListener('click', () => this.searchByCode());
    }

    handleLogoUpload(e) {
      const file = e.target.files[0];
      if (!file) {
        this.logoImage = null;
        this.logoSizeGroup.style.display = 'none';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          this.logoImage = img;
          this.logoSizeGroup.style.display = 'block';
          console.log('Logo cargado:', img.width, 'x', img.height);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    handleTypeChange() {
      // Hide all dynamic fields
      const allFields = [this.urlFields, this.textFields, this.emailFields, 
                        this.phoneFields, this.smsFields, this.wifiFields];
      allFields.forEach(field => field.style.display = 'none');
      
      // Show relevant fields
      const type = this.qrType.value;
      switch(type) {
        case 'url':
          this.urlFields.style.display = 'block';
          break;
        case 'text':
          this.textFields.style.display = 'block';
          break;
        case 'email':
          this.emailFields.style.display = 'block';
          break;
        case 'phone':
          this.phoneFields.style.display = 'block';
          break;
        case 'sms':
          this.smsFields.style.display = 'block';
          break;
        case 'wifi':
          this.wifiFields.style.display = 'block';
          break;
      }
    }

    getQRContent() {
      const type = this.qrType.value;
      let content = '';
      let displayContent = '';
      let isWhatsApp = false;
      
      switch(type) {
        case 'url':
          content = this.qrContent.value.trim();
          displayContent = content;
          if (content && !content.startsWith('http://') && !content.startsWith('https://')) {
            content = 'https://' + content;
          }
          break;
        
        case 'text':
          content = document.getElementById('textContent').value.trim();
          displayContent = content;
          break;
        
        case 'email':
          const email = document.getElementById('emailAddress').value.trim();
          const subject = document.getElementById('emailSubject').value.trim();
          content = `mailto:${email}${subject ? '?subject=' + encodeURIComponent(subject) : ''}`;
          displayContent = email;
          break;
        
        case 'phone':
          const phone = document.getElementById('phoneNumber').value.trim();
          const useWhatsApp = document.getElementById('useWhatsApp').checked;
          
          if (useWhatsApp) {
            // Limpiar el número de teléfono (quitar espacios, guiones, etc.)
            const cleanPhone = phone.replace(/\D/g, '');
            const whatsappMessage = document.getElementById('whatsappMessage').value.trim();
            
            if (whatsappMessage) {
              content = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(whatsappMessage)}`;
            } else {
              content = `https://wa.me/${cleanPhone}`;
            }
            displayContent = `WhatsApp: ${phone}`;
            isWhatsApp = true;
          } else {
            content = `tel:${phone}`;
            displayContent = phone;
          }
          break;
        
        case 'sms':
          const smsNumber = document.getElementById('smsNumber').value.trim();
          const smsMessage = document.getElementById('smsMessage').value.trim();
          content = `sms:${smsNumber}${smsMessage ? '?body=' + encodeURIComponent(smsMessage) : ''}`;
          displayContent = smsNumber;
          break;
        
        case 'wifi':
          const ssid = document.getElementById('wifiSSID').value.trim();
          const password = document.getElementById('wifiPassword').value.trim();
          const encryption = document.getElementById('wifiEncryption').value;
          content = `WIFI:T:${encryption};S:${ssid};P:${password};;`;
          displayContent = ssid;
          break;
      }
      
      return { content, displayContent, type, isWhatsApp };
    }

    generateQR() {
      const { content, displayContent, type, isWhatsApp } = this.getQRContent();
      
      if (!content) {
        alert('Por favor, completa los campos requeridos');
        return;
      }
      
      console.log('Generando QR con:', { content, displayContent, type, isWhatsApp });
      
      // Clear previous QR
      this.qrPreview.innerHTML = '';
      
      try {
        // Get style options
        const style = this.qrStyle.value;
        const cornerStyle = this.cornerStyle.value;
        const logoSizePercent = parseInt(this.logoSize.value);
        
        // Create canvas element
        const canvas = document.createElement('canvas');
        const size = 512; // Increased for better quality
        canvas.width = size;
        canvas.height = size;
        
        // Generate base QR code using QRious
        const tempCanvas = document.createElement('canvas');
        const qr = new QRious({
          element: tempCanvas,
          value: content,
          size: size,
          foreground: this.qrColor.value,
          background: '#ffffff',
          level: 'H' // High error correction for logo support
        });
        
        // Apply custom style
        this.applyCustomStyle(canvas, tempCanvas, style, cornerStyle);
        
        // Add logo if provided
        if (this.logoImage) {
          this.addLogoToQR(canvas, this.logoImage, logoSizePercent);
        }
        
        // Scale down for preview
        const previewCanvas = document.createElement('canvas');
        previewCanvas.width = 256;
        previewCanvas.height = 256;
        const previewCtx = previewCanvas.getContext('2d');
        previewCtx.imageSmoothingEnabled = true;
        previewCtx.imageSmoothingQuality = 'high';
        previewCtx.drawImage(canvas, 0, 0, 256, 256);
        
        this.qrPreview.appendChild(previewCanvas);
        console.log('QR generado exitosamente con estilo:', style);
      } catch (error) {
        console.error('Error generando QR:', error);
        alert('Error al generar el código QR. Por favor, verifica los datos e intenta de nuevo.');
        return;
      }
      
      // Show preview
      this.previewCard.style.display = 'flex';
      this.previewInfo.innerHTML = `
        <strong>${isWhatsApp ? 'WhatsApp' : this.getTypeName(type)}</strong><br>
        ${displayContent}
      `;
      
      // Save to storage with style info
      const qrData = {
        id: Date.now().toString(),
        name: this.qrName.value.trim() || `QR ${isWhatsApp ? 'WhatsApp' : this.getTypeName(type)}`,
        type: type,
        content: content,
        displayContent: displayContent,
        color: this.qrColor.value,
        style: this.qrStyle.value,
        cornerStyle: this.cornerStyle.value,
        hasLogo: !!this.logoImage,
        logoData: this.logoImage ? this.logoImage.src : null,
        logoSize: parseInt(this.logoSize.value),
        isWhatsApp: isWhatsApp,
        createdAt: new Date().toISOString(),
        timestamp: Date.now()
      };
      
      const uniqueCode = this.storage.save(qrData);
      this.currentQR = { ...qrData, uniqueCode };
      this.currentQRCanvas = this.qrPreview.querySelector('canvas');
      
      // Show unique code
      this.uniqueCodeBox.style.display = 'flex';
      this.uniqueCodeValue.textContent = uniqueCode;
      
      // Scroll to preview
      this.previewCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    applyCustomStyle(canvas, sourceCanvas, style, cornerStyle) {
      const ctx = canvas.getContext('2d');
      const srcCtx = sourceCanvas.getContext('2d');
      const size = canvas.width;
      const imageData = srcCtx.getImageData(0, 0, size, size);
      const data = imageData.data;
      
      // Fill white background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, size, size);
      ctx.fillStyle = this.qrColor.value;
      
      // Calculate module size
      let moduleCount = 0;
      for (let y = 0; y < size; y++) {
        const i = (y * size) * 4;
        if (data[i] === 0) {
          moduleCount++;
          break;
        }
      }
      
      // Find first black pixel to determine module size
      let moduleSize = 1;
      for (let x = 0; x < size; x++) {
        const i = x * 4;
        if (data[i] === 0) {
          moduleSize = 1;
          for (let x2 = x + 1; x2 < size; x2++) {
            const i2 = x2 * 4;
            if (data[i2] !== 0) break;
            moduleSize++;
          }
          break;
        }
      }
      
      const modules = Math.floor(size / moduleSize);
      
      // Draw modules with custom style
      for (let row = 0; row < modules; row++) {
        for (let col = 0; col < modules; col++) {
          const x = col * moduleSize + Math.floor(moduleSize / 2);
          const y = row * moduleSize + Math.floor(moduleSize / 2);
          const i = (y * size + x) * 4;
          
          if (data[i] === 0) { // Black module
            const xPos = col * moduleSize;
            const yPos = row * moduleSize;
            
            // Check if it's a corner pattern (position detection pattern)
            const isCorner = this.isCornerPattern(row, col, modules);
            
            if (isCorner) {
              this.drawCornerPattern(ctx, xPos, yPos, moduleSize, cornerStyle);
            } else {
              this.drawModule(ctx, xPos, yPos, moduleSize, style);
            }
          }
        }
      }
    }

    isCornerPattern(row, col, modules) {
      // Top-left corner
      if (row < 7 && col < 7) return true;
      // Top-right corner
      if (row < 7 && col >= modules - 7) return true;
      // Bottom-left corner
      if (row >= modules - 7 && col < 7) return true;
      return false;
    }

    drawCornerPattern(ctx, x, y, moduleSize, cornerStyle) {
      ctx.fillStyle = this.qrColor.value;
      
      switch(cornerStyle) {
        case 'rounded':
          ctx.beginPath();
          const radius = moduleSize * 0.4;
          ctx.roundRect(x, y, moduleSize, moduleSize, radius);
          ctx.fill();
          break;
        case 'dot':
          ctx.beginPath();
          ctx.arc(x + moduleSize/2, y + moduleSize/2, moduleSize/2, 0, Math.PI * 2);
          ctx.fill();
          break;
        default: // square
          ctx.fillRect(x, y, moduleSize, moduleSize);
      }
    }

    drawModule(ctx, x, y, moduleSize, style) {
      ctx.fillStyle = this.qrColor.value;
      
      switch(style) {
        case 'dots':
          ctx.beginPath();
          ctx.arc(x + moduleSize/2, y + moduleSize/2, moduleSize/2.5, 0, Math.PI * 2);
          ctx.fill();
          break;
        case 'rounded':
          ctx.beginPath();
          const radius = moduleSize * 0.3;
          ctx.roundRect(x, y, moduleSize, moduleSize, radius);
          ctx.fill();
          break;
        default: // squares
          ctx.fillRect(x, y, moduleSize, moduleSize);
      }
    }

    addLogoToQR(canvas, logoImg, sizePercent) {
      const ctx = canvas.getContext('2d');
      const size = canvas.width;
      const logoSize = (size * sizePercent) / 100;
      
      // Calculate logo position (center)
      const x = (size - logoSize) / 2;
      const y = (size - logoSize) / 2;
      
      // Draw white background circle for logo
      const bgPadding = logoSize * 0.15;
      const bgSize = logoSize + (bgPadding * 2);
      ctx.fillStyle = '#ffffff';
      ctx.beginPath();
      ctx.arc(size/2, size/2, bgSize/2, 0, Math.PI * 2);
      ctx.fill();
      
      // Draw logo
      ctx.save();
      ctx.beginPath();
      ctx.arc(size/2, size/2, logoSize/2, 0, Math.PI * 2);
      ctx.clip();
      ctx.drawImage(logoImg, x, y, logoSize, logoSize);
      ctx.restore();
    }

    // Helper function to regenerate QR with saved styles
    regenerateQRWithStyle(code, size = 256) {
      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      
      // Generate base QR
      const tempCanvas = document.createElement('canvas');
      new QRious({
        element: tempCanvas,
        value: code.content,
        size: size,
        foreground: code.color || '#000000',
        background: '#ffffff',
        level: 'H'
      });
      
      // Apply custom style if available
      if (code.style || code.cornerStyle) {
        this.applyCustomStyle(
          canvas, 
          tempCanvas, 
          code.style || 'squares', 
          code.cornerStyle || 'square'
        );
      } else {
        // No custom style, just copy
        const ctx = canvas.getContext('2d');
        ctx.drawImage(tempCanvas, 0, 0);
      }
      
      // Add logo if available
      if (code.hasLogo && code.logoData) {
        const logoImg = new Image();
        logoImg.src = code.logoData;
        // Wait for logo to load
        return new Promise((resolve) => {
          logoImg.onload = () => {
            this.addLogoToQR(canvas, logoImg, code.logoSize || 20);
            resolve(canvas);
          };
          logoImg.onerror = () => {
            console.error('Error loading logo from saved data');
            resolve(canvas);
          };
        });
      }
      
      return Promise.resolve(canvas);
    }

    getTypeName(type) {
      const types = {
        'url': 'URL',
        'text': 'Texto',
        'email': 'Email',
        'phone': 'Teléfono',
        'sms': 'SMS',
        'wifi': 'WiFi'
      };
      return types[type] || type;
    }

    downloadQR(format) {
      if (!this.currentQR) return;
      
      const canvas = this.currentQRCanvas || this.qrPreview.querySelector('canvas');
      if (!canvas) return;
      
      // Create high-res version for download
      const downloadCanvas = document.createElement('canvas');
      downloadCanvas.width = 1024;
      downloadCanvas.height = 1024;
      const ctx = downloadCanvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(canvas, 0, 0, 1024, 1024);
      
      if (format === 'png') {
        const url = downloadCanvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = `${this.currentQR.name.replace(/[^a-z0-9]/gi, '_')}_${this.currentQR.id}.png`;
        a.click();
      } else if (format === 'svg') {
        // Convert canvas to SVG (simplified version)
        this.downloadCanvasAsSVG(downloadCanvas, this.currentQR.name);
      }
    }

    downloadCanvasAsSVG(canvas, name) {
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      
      let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">`;
      
      // Create rectangles for each pixel
      for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) {
          const i = (y * canvas.width + x) * 4;
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          const a = data[i + 3] / 255;
          
          if (a > 0 && (r < 200 || g < 200 || b < 200)) {
            const color = `rgb(${r},${g},${b})`;
            svg += `<rect x="${x}" y="${y}" width="1" height="1" fill="${color}" opacity="${a}"/>`;
          }
        }
      }
      
      svg += '</svg>';
      
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.svg`;
      a.click();
      URL.revokeObjectURL(url);
    }

    copyUniqueCode() {
      const code = this.uniqueCodeValue.textContent;
      navigator.clipboard.writeText(code).then(() => {
        // Visual feedback
        const originalText = this.copyCodeBtn.innerHTML;
        this.copyCodeBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        `;
        this.copyCodeBtn.style.background = '#10b981';
        
        setTimeout(() => {
          this.copyCodeBtn.innerHTML = originalText;
          this.copyCodeBtn.style.background = '';
        }, 2000);
      }).catch(err => {
        console.error('Error copiando código:', err);
        alert('Error al copiar el código');
      });
    }

    async searchByCode() {
      const code = this.codeSearchInput.value.trim();
      
      if (!code) {
        alert('Por favor, ingresa un código para buscar');
        return;
      }
      
      if (code.length !== 6) {
        this.searchResultBox.innerHTML = `
          <div class="search-error">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p>El código debe tener 6 caracteres</p>
          </div>
        `;
        this.searchResultBox.style.display = 'flex';
        return;
      }
      
      const qrData = this.storage.findByCode(code);
      
      if (!qrData) {
        this.searchResultBox.innerHTML = `
          <div class="search-error">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <p>No se encontró ningún código QR con el código: <strong>${code}</strong></p>
            <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem;">Verifica que el código sea correcto</p>
          </div>
        `;
        this.searchResultBox.style.display = 'flex';
        return;
      }
      
      // Show QR result
      const canvas = await this.regenerateQRWithStyle(qrData, 200);
      const date = new Date(qrData.createdAt);
      const formattedDate = date.toLocaleDateString('es-ES', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      this.searchResultBox.innerHTML = `
        <div class="search-success">
          <div class="search-qr-preview"></div>
          <div class="search-qr-info">
            <h3>${qrData.name}</h3>
            <p><strong>Tipo:</strong> ${qrData.isWhatsApp ? 'WhatsApp' : this.getTypeName(qrData.type)}</p>
            <p><strong>Contenido:</strong> ${qrData.displayContent}</p>
            <p><strong>Código único:</strong> <code>${qrData.uniqueCode}</code></p>
            <p><strong>Creado:</strong> ${formattedDate}</p>
            <div class="search-actions">
              <button class="btn btn-primary" onclick="app.downloadSearchResult('${qrData.id}', 'png')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Descargar PNG
              </button>
              <button class="btn" onclick="app.downloadSearchResult('${qrData.id}', 'svg')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Descargar SVG
              </button>
            </div>
          </div>
        </div>
      `;
      
      this.searchResultBox.style.display = 'flex';
      this.searchResultBox.querySelector('.search-qr-preview').appendChild(canvas);
      
      // Store for download
      this.searchResultCanvas = canvas;
      this.searchResultData = qrData;
    }

    downloadSearchResult(id, format) {
      if (!this.searchResultCanvas || !this.searchResultData) return;
      
      const qrData = this.searchResultData;
      const fileName = `${qrData.name.replace(/\s+/g, '_')}_${qrData.uniqueCode}`;
      
      if (format === 'svg') {
        // Convert canvas to SVG
        const svgData = this.canvasToSVG(this.searchResultCanvas);
        const blob = new Blob([svgData], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${fileName}.svg`;
        a.click();
        URL.revokeObjectURL(url);
      } else {
        // High-res PNG export
        const highResCanvas = document.createElement('canvas');
        highResCanvas.width = 1024;
        highResCanvas.height = 1024;
        const ctx = highResCanvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(this.searchResultCanvas, 0, 0, 1024, 1024);
        
        highResCanvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${fileName}.png`;
          a.click();
          URL.revokeObjectURL(url);
        }, 'image/png');
      }
    }
  }

  // Initialize app when DOM and QRious are ready and make it globally accessible
  window.app = new QRGenerator();
  
  }); // End window.addEventListener('load')
</script>
